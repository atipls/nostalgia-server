mod connection;

use connection::Connection;
use network::protocol::ConnectedPacket;
use network::reliability::FrameVec;
use network::{listener::Listener, NetworkError};
use protocol::Packet;
use std::num::NonZeroU32;
use std::{path::PathBuf, sync::Arc};
use tokio::sync::{
    mpsc::{channel, Receiver, Sender},
    Mutex, Semaphore,
};
use world::World;

struct Application {
    listener: Listener,
    world: Arc<Mutex<World>>,
    connections: Arc<Mutex<Vec<Arc<Mutex<Connection>>>>>,
    global_packet_sender: Arc<Mutex<Sender<(Option<NonZeroU32>, Packet)>>>,
    global_packet_receiver: Arc<Mutex<Receiver<(Option<NonZeroU32>, Packet)>>>,
    disconnection_notifier: Arc<Semaphore>,
}

impl Application {
    pub fn new(listener: Listener, world: World) -> Self {
        let (global_packet_sender, global_packet_receiver) = channel(64);

        Self {
            listener,
            world: Arc::new(Mutex::new(world)),
            connections: Arc::new(Mutex::new(Vec::new())),
            global_packet_sender: Arc::new(Mutex::new(global_packet_sender)),
            global_packet_receiver: Arc::new(Mutex::new(global_packet_receiver)),
            disconnection_notifier: Arc::new(Semaphore::new(0)),
        }
    }

    pub async fn run(&mut self) -> Result<(), NetworkError> {
        loop {
            tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
            let peer = self.listener.accept().await?;

            let world = self.world.clone();
            let global_packet_sender = self.global_packet_sender.clone();
            let connection = Arc::new(Mutex::new(Connection::new(
                peer,
                world,
                global_packet_sender,
            )));
            let mut connections = self.connections.lock().await;
            connections.push(connection.clone());

            let disconnection_notifier = self.disconnection_notifier.clone();
            tokio::spawn(async move {
                let disconnection_notifier = disconnection_notifier.clone();
                loop {
                    let mut connection = connection.lock().await;
                    match connection.update().await {
                        Ok(_) => {}
                        Err(NetworkError::ConnectionClosed) => {
                            connection.disconnect();
                            println!("Connection closed (disconnected)");
                            break;
                        }
                        Err(error) => {
                            connection.disconnect();
                            println!("Connection closed ({:#?})", error);
                            break;
                        }
                    }
                }

                disconnection_notifier.add_permits(1);
            });

            let global_packet_receiver = self.global_packet_receiver.clone();
            let connections = self.connections.clone();
            let disconnection_notifier = self.disconnection_notifier.clone();
            tokio::spawn(async move {
                loop {
                    let disconnection_notifier = disconnection_notifier.clone();
                    let mut global_packet_receiver = global_packet_receiver.lock().await;
                    tokio::select! {
                        packet = global_packet_receiver.recv() => {
                            if let Some((exclude, packet)) = packet {
                                let connections = connections.lock().await;
                                for connection in connections.iter() {
                                    let mut connection = connection.lock().await;
                                    if let Some(exclude) = exclude {
                                        if connection.client_id() == Some(exclude) {
                                            continue;
                                        }
                                    }
                                    connection.send_packet(packet.clone()).await.expect("Failed to send a global packet");
                                }
                            }
                        }
                        disconnection_permit = disconnection_notifier.acquire() => {
                            let mut connections = connections.lock().await;
                            connections.retain(|connection| {
                                let Ok(connection) = connection.try_lock() else {
                                    return true; // We can't lock the connection, so we assume it's still in use
                                };

                                connection.connected()
                            });
                        }
                    }
                }
            });
        }
    }
}

#[tokio::main]
async fn main() {
    console_subscriber::init();
    let address = "0.0.0.0:19132".parse().expect("Address is already in use");
    let listener = Listener::started(&address, "Nostalgia Server".to_string())
        .await
        .expect("Failed to start the server");

    let world_path = PathBuf::from("assets/MainWorld");
    let world = World::from_file(world_path).expect("Failed to load the world");
    let packet_bytes: [u8; 1209] = [
        0x8c, 0xca, 0x00, 0x00, 0x60, 0x06, 0xf0, 0xd1, 0x15, 0x00, 0x44, 0x00, 0x00, 0x00, 0xb4,
        0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x09, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x60, 0x00, 0xd0, 0xd2,
        0x15, 0x00, 0x45, 0x00, 0x00, 0x00, 0xb4, 0x78, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x60, 0x08, 0x48, 0xd3, 0x15, 0x00, 0x46, 0x00, 0x00, 0x00, 0x9f, 0x00, 0x00,
        0x00, 0x0f, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x30, 0xd4, 0x15, 0x00, 0x94, 0x00,
        0x00, 0x00, 0x01, 0xc4, 0x40, 0x00, 0xc8, 0xd5, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x04,
        0x40, 0x27, 0xc1, 0x00, 0x42, 0x94, 0x00, 0x00, 0x42, 0xde, 0xfe, 0xfc, 0xc3, 0x4a, 0xff,
        0x10, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x30, 0xd6, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00,
        0x0c, 0xca, 0x40, 0x00, 0xc8, 0xd7, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x0d, 0x42, 0x2e,
        0x33, 0x33, 0x42, 0x86, 0x00, 0x00, 0x43, 0x6e, 0xd6, 0x4f, 0xc2, 0x58, 0xa0, 0x0f, 0x00,
        0x00, 0x00, 0x00, 0x40, 0x00, 0xc8, 0xd8, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x10, 0x42,
        0x40, 0x6a, 0x31, 0x42, 0x88, 0x00, 0x00, 0x43, 0x72, 0x3b, 0x2d, 0xc4, 0x59, 0xe1, 0x25,
        0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x30, 0xd9, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00, 0x10,
        0x6d, 0x40, 0x00, 0xc8, 0xda, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x11, 0x42, 0x47, 0x17,
        0xaf, 0x42, 0x88, 0x00, 0x00, 0x43, 0x72, 0x3e, 0x3c, 0x44, 0x22, 0x5a, 0x3e, 0x00, 0x00,
        0x00, 0x00, 0x40, 0x00, 0xc8, 0xdb, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x12, 0x42, 0x3a,
        0x55, 0x93, 0x42, 0x88, 0x81, 0x20, 0x43, 0x72, 0xa9, 0x1e, 0xc4, 0x4d, 0x3d, 0x44, 0x00,
        0x00, 0x00, 0x00, 0x40, 0x00, 0x58, 0xdc, 0x15, 0x00, 0xa8, 0x00, 0x00, 0x00, 0x12, 0x00,
        0x5d, 0xfd, 0xa5, 0xff, 0x74, 0x40, 0x00, 0xc8, 0xdd, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00,
        0x18, 0x42, 0xcb, 0x00, 0x29, 0x42, 0x95, 0xd7, 0xdc, 0x43, 0x02, 0xb9, 0xcc, 0x45, 0x3f,
        0x3d, 0x83, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x58, 0xde, 0x15, 0x00, 0xa8, 0x00, 0x00,
        0x00, 0x18, 0xff, 0xfe, 0xfd, 0x17, 0xfe, 0x7a, 0x40, 0x00, 0xc8, 0xdf, 0x15, 0x00, 0x93,
        0x00, 0x00, 0x00, 0x19, 0x42, 0xc5, 0x00, 0x2f, 0x42, 0x91, 0x05, 0x0b, 0x43, 0x02, 0x80,
        0x13, 0x42, 0xad, 0x9b, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0xc8, 0xe0, 0x15, 0x00,
        0x93, 0x00, 0x00, 0x00, 0x1c, 0x42, 0xcb, 0x28, 0x27, 0x42, 0x94, 0x1d, 0xf7, 0x43, 0x02,
        0x17, 0x22, 0xc2, 0x1d, 0x84, 0x28, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x58, 0xe1, 0x15,
        0x00, 0xa8, 0x00, 0x00, 0x00, 0x1c, 0x00, 0xa6, 0xfc, 0x72, 0xfd, 0x82, 0x40, 0x00, 0x30,
        0xe2, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00, 0x1c, 0xa3, 0x40, 0x00, 0x58, 0xe3, 0x15, 0x00,
        0xa8, 0x00, 0x00, 0x00, 0x1e, 0xff, 0xbb, 0xfd, 0x8d, 0x00, 0x65, 0x40, 0x00, 0xc8, 0xe4,
        0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x1f, 0x43, 0x02, 0x7d, 0x3b, 0x42, 0x8b, 0x88, 0x61,
        0x43, 0x4f, 0x99, 0x56, 0xc3, 0xbf, 0x64, 0x34, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x58,
        0xe5, 0x15, 0x00, 0xa8, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xdb, 0xf8, 0xcc, 0x01, 0x8b, 0x40,
        0x00, 0xc8, 0xe6, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x26, 0x42, 0xdf, 0xc7, 0x23, 0x42,
        0x8e, 0x00, 0x00, 0x43, 0x39, 0xf0, 0xc8, 0xc3, 0xf6, 0x43, 0x3c, 0x00, 0x00, 0x00, 0x00,
        0x40, 0x00, 0x30, 0xe7, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00, 0x26, 0x6c, 0x40, 0x00, 0x30,
        0xe8, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00, 0x2a, 0xac, 0x40, 0x00, 0xc8, 0xe9, 0x15, 0x00,
        0x93, 0x00, 0x00, 0x00, 0x2e, 0x43, 0x3c, 0x60, 0xbe, 0x42, 0x90, 0x00, 0x00, 0x43, 0x0f,
        0x43, 0x45, 0xc2, 0x28, 0xd3, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x58, 0xea, 0x15,
        0x00, 0xa8, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x5a, 0xfd, 0x8d, 0x00, 0xe4, 0x40, 0x00, 0xc8,
        0xeb, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x30, 0x43, 0x3a, 0x23, 0x78, 0x42, 0x90, 0x00,
        0x00, 0x43, 0x0d, 0x4f, 0xf0, 0x43, 0x9b, 0x8b, 0xb9, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00,
        0x58, 0xec, 0x15, 0x00, 0xa8, 0x00, 0x00, 0x00, 0x30, 0x00, 0xab, 0xfd, 0x8d, 0x00, 0x94,
        0x40, 0x00, 0xc8, 0xed, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x35, 0x43, 0x41, 0x78, 0xdf,
        0x42, 0x8e, 0x00, 0x00, 0x43, 0x1a, 0xcc, 0x84, 0xc2, 0x5e, 0xcd, 0x2c, 0x00, 0x00, 0x00,
        0x00, 0x40, 0x00, 0xc8, 0xee, 0x15, 0x00, 0x93, 0x00, 0x00, 0x00, 0x39, 0x43, 0x6a, 0x45,
        0xee, 0x42, 0x8a, 0x00, 0x00, 0x43, 0x3e, 0x92, 0x13, 0xc4, 0x36, 0x58, 0xab, 0x00, 0x00,
        0x00, 0x00, 0x40, 0x00, 0x30, 0xef, 0x15, 0x00, 0x94, 0x00, 0x00, 0x00, 0x39, 0x39, 0x40,
        0x00, 0x58, 0xf0, 0x15, 0x00, 0xa8, 0x00, 0x00, 0x00, 0x3b, 0xff, 0x84, 0xfd, 0x8d, 0xff,
        0x6e, 0x40, 0x00, 0x10, 0xf1, 0x15, 0x00, 0xaa, 0x14,
    ];

    dump_wireshark_packets(&packet_bytes);

    let mut application = Application::new(listener, world);
    match application.run().await {
        Ok(_) => println!("Server closed"),
        Err(error) => println!("Server closed ({:#?})", error),
    }
}

fn dump_wireshark_packets(packet_bytes: &[u8]) {
    let frame_vec = FrameVec::new(Vec::from(packet_bytes)).unwrap();
    for frame in frame_vec.frames {
        let mut cursor = std::io::Cursor::new(frame.data.clone());
        match ConnectedPacket::parse(&mut cursor).unwrap() {
            Some(connected_packet) => {
                println!("Parsed connected packet {:?}", connected_packet);
            }
            None => {
                let mut payload_cursor = std::io::Cursor::new(frame.data.clone());
                while let Ok(Some(packet)) = Packet::parse(&mut payload_cursor) {
                    println!("Parsed packet {:?}", packet);
                }
            }
        };
    }
}